// ================================// File: src/pages/OrganizationalChart.tsx// FULL REPLACEMENT// ================================import React, { useState, useEffect, useRef } from 'react';import { useNavigate } from 'react-router-dom';import { Users, Search, Minimize2, Maximize2, ChevronDown, ChevronRight } from 'lucide-react';import { MasterToolbar } from '../components/ui/MasterToolbar';import { orgChartService, OrgChartNode } from '../services/orgChartService';import '../styles/orgChart.css';interface HierarchyData {  hierarchy: OrgChartNode[];  total_employees: number;  levels: number;}const OrganizationalChart: React.FC = () => {  const navigate = useNavigate();  const [hierarchyData, setHierarchyData] = useState<HierarchyData | null>(null);  const [expandedNodes, setExpandedNodes] = useState<Set<string>>(new Set());  const [selectedEmployee, setSelectedEmployee] = useState<OrgChartNode | null>(null);  const [searchTerm, setSearchTerm] = useState('');  const [zoomLevel, setZoomLevel] = useState(1);  const [loading, setLoading] = useState(true);  const [error, setError] = useState<string | null>(null);  const chartRef = useRef<HTMLDivElement>(null);  const loadHierarchy = async () => {    try {      setLoading(true);      const data = await orgChartService.getHierarchy();      setHierarchyData(data);      const all = new Set<string>();      const walk = (nodes: OrgChartNode[]) => {        nodes.forEach(n => {          all.add(String(n.id));          if (n.children?.length) walk(n.children);        });      };      walk(data.hierarchy);      setExpandedNodes(all);    } catch {      setError('Failed to load org chart');    } finally {      setLoading(false);    }  };  useEffect(() => {    loadHierarchy();  }, []);  const toggle = (id: string) => {    const copy = new Set(expandedNodes);    copy.has(id) ? copy.delete(id) : copy.add(id);    setExpandedNodes(copy);  };  const OrgNode = ({ node }: { node: OrgChartNode }) => {    const expanded = expandedNodes.has(String(node.id));    const hasChildren = node.children?.length;    return (      <div className="org-node-wrapper">        <div          className={`org-card ${selectedEmployee?.id === node.id ? 'selected' : ''}`}          onClick={() => setSelectedEmployee(node)}        >          <div className="avatar">            {node.full_name.split(' ').map(x => x[0]).join('').slice(0, 2)}          </div>          <div className="meta">            <div className="name">{node.full_name}</div>            <div className="title">{node.position_title}</div>            <div className="dept">{node.department_name}</div>            <div className="id">{node.employee_number}</div>          </div>          {hasChildren && (            <button              onClick={(e) => { e.stopPropagation(); toggle(String(node.id)); }}              className="toggle"            >              {expanded ? <ChevronDown size={14} /> : <ChevronRight size={14} />}            </button>          )}        </div>        {hasChildren && expanded && (          <div className="children">            {node.children.map(child => (              <OrgNode key={child.id} node={child} />            ))}          </div>        )}      </div>    );  };  if (loading) return <div className="p-10">Loading...</div>;  if (error) return <div className="p-10">{error}</div>;  return (    <div className="min-h-screen bg-gray-50">      <MasterToolbar viewId="HRM_ORG_CHART" mode="VIEW" hasSelection={!!selectedEmployee} onAction={()=>{}} />      <div className="p-6 flex justify-between items-center bg-white border-b">        <div>          <h1 className="text-xl font-bold">Organizational Chart</h1>          <p className="text-sm text-gray-500">            {hierarchyData?.total_employees} employees â€¢ {hierarchyData?.levels} levels          </p>        </div>        <div className="flex gap-3 items-center">          <input            placeholder="Search..."            value={searchTerm}            onChange={e => setSearchTerm(e.target.value)}            className="border px-3 py-1 rounded"          />          <button onClick={() => setZoomLevel(z => Math.max(0.5, z - 0.1))}><Minimize2 /></button>          <span>{Math.round(zoomLevel * 100)}%</span>          <button onClick={() => setZoomLevel(z => Math.min(2, z + 0.1))}><Maximize2 /></button>        </div>      </div>      <div        ref={chartRef}        className="org-root"        style={{ transform: `scale(${zoomLevel})`, transformOrigin: 'top center' }}      >        {hierarchyData?.hierarchy.map(node => (          <OrgNode key={node.id} node={node} />        ))}      </div>    </div>  );};export default OrganizationalChart;
