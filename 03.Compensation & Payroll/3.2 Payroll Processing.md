# 3.2 Payroll Processing

## 3.2.1 Business Purpose

Payroll Processing provides a comprehensive system for calculating, processing, and distributing employee compensation accurately and timely. This ensures statutory compliance, tax accuracy, benefit deductions, and payment processing while maintaining audit trails, supporting multiple pay frequencies, handling complex compensation scenarios, and enabling efficient payroll operations across the organization.

## 3.2.2 Business Scope

Enable complete payroll processing management including payroll calculation engines, pay period management, earnings and deductions processing, tax calculations, benefit deductions, multi-state payroll support, compliance reporting, and payment processing. The system supports automated calculations, approval workflows, direct deposit management, check printing, third-party integrations, and comprehensive reporting while ensuring accuracy, timeliness, and regulatory compliance.

## 3.2.3 Payroll Run Master Schema

```
Table: payroll_run
Fields:
- id: UUID (Primary Key)
- company_id: UUID (Foreign Key to company)
- run_number: VARCHAR(50) (Required, Unique, Indexed)
- run_type: ENUM('Regular', 'Off-Cycle', 'Bonus', 'Commission', 'Termination', 'Adjustment', 'Retroactive')
- pay_period_id: UUID (Foreign Key to pay_period)
- payroll_frequency: ENUM('Weekly', 'Bi-Weekly', 'Semi-Monthly', 'Monthly', 'Quarterly', 'Annual')
- run_status: ENUM('Draft', 'Calculating', 'Calculated', 'Under Review', 'Approved', 'Processed', 'Paid', 'Cancelled', 'Failed')
- run_date: DATE (Required)
- pay_date: DATE (Required)
- process_start_time: TIMESTAMP
- process_end_time: TIMESTAMP
- total_employees: INTEGER (Default: 0)
- processed_employees: INTEGER (Default: 0)
- failed_employees: INTEGER (Default: 0)
- gross_pay_total: DECIMAL(15,2) (Default: 0.00)
- net_pay_total: DECIMAL(15,2) (Default: 0.00)
- tax_deductions_total: DECIMAL(15,2) (Default: 0.00)
- benefit_deductions_total: DECIMAL(15,2) (Default: 0.00)
- other_deductions_total: DECIMAL(15,2) (Default: 0.00)
- currency_code: VARCHAR(10) (Default: 'USD')
- exchange_rate: DECIMAL(10,6) (Default: 1.000000)
- approval_workflow_id: UUID (Foreign Key to approval_workflow)
- approved_by_user_id: UUID (Foreign Key to user)
- approved_at: TIMESTAMP
- processed_by_user_id: UUID (Foreign Key to user)
- processed_at: TIMESTAMP
- payment_method: ENUM('Direct Deposit', 'Check', 'Cash', 'Wire Transfer')
- bank_batch_id: VARCHAR(100)
- check_run_number: VARCHAR(50)
- calculation_parameters: JSON (Payroll calculation rules and parameters)
- error_summary: TEXT
- run_notes: TEXT
- created_by_user_id: UUID (Foreign Key to user)
- created_at: TIMESTAMP (Auto)
- updated_at: TIMESTAMP (Auto)

Indexes:
- PRIMARY KEY (id)
- UNIQUE KEY uk_run_number_company (run_number, company_id)
- INDEX idx_company_id (company_id)
- INDEX idx_pay_period_id (pay_period_id)
- INDEX idx_run_type (run_type)
- INDEX idx_run_status (run_status)
- INDEX idx_run_date (run_date)
- INDEX idx_pay_date (pay_date)
- INDEX idx_approval_workflow_id (approval_workflow_id)

Constraints:
- fk_payroll_run_company FOREIGN KEY (company_id) REFERENCES company(id)
- fk_payroll_run_period FOREIGN KEY (pay_period_id) REFERENCES pay_period(id)
- fk_payroll_run_workflow FOREIGN KEY (approval_workflow_id) REFERENCES approval_workflow(id)
- fk_payroll_run_approved_by FOREIGN KEY (approved_by_user_id) REFERENCES user(id)
- fk_payroll_run_processed_by FOREIGN KEY (processed_by_user_id) REFERENCES user(id)
- fk_payroll_run_created_by FOREIGN KEY (created_by_user_id) REFERENCES user(id)
- chk_employee_counts_valid CHECK (total_employees >= processed_employees AND total_employees >= failed_employees)
```

## 3.2.4 Pay Period Management Schema

```
Table: pay_period
Fields:
- id: UUID (Primary Key)
- company_id: UUID (Foreign Key to company)
- period_code: VARCHAR(50) (Required, Unique, Indexed)
- period_name: VARCHAR(100) (Required)
- period_type: ENUM('Weekly', 'Bi-Weekly', 'Semi-Monthly', 'Monthly', 'Quarterly', 'Annual')
- frequency_code: VARCHAR(20) (Required)
- start_date: DATE (Required)
- end_date: DATE (Required)
- pay_date: DATE (Required)
- fiscal_year: INTEGER (Required)
- fiscal_quarter: INTEGER (Check: 1 TO 4)
- fiscal_month: INTEGER (Check: 1 TO 12)
- period_number: INTEGER (Required)
- is_active: BOOLEAN (Default: TRUE)
- is_locked: BOOLEAN (Default: FALSE)
- locked_by_user_id: UUID (Foreign Key to user)
- locked_at: TIMESTAMP
- currency_code: VARCHAR(10) (Default: 'USD')
- processing_deadline: DATE
- approval_deadline: DATE
- payment_deadline: DATE
- holiday_adjustments: JSON (Holiday and weekend adjustments)
- special_instructions: TEXT
- created_by_user_id: UUID (Foreign Key to user)
- created_at: TIMESTAMP (Auto)
- updated_at: TIMESTAMP (Auto)

Indexes:
- PRIMARY KEY (id)
- UNIQUE KEY uk_period_code_company (period_code, company_id)
- INDEX idx_company_id (company_id)
- INDEX idx_period_type (period_type)
- INDEX idx_start_date (start_date)
- INDEX idx_end_date (end_date)
- INDEX idx_pay_date (pay_date)
- INDEX idx_fiscal_year (fiscal_year)
- INDEX idx_is_active (is_active)
- INDEX idx_is_locked (is_locked)

Constraints:
- fk_pay_period_company FOREIGN KEY (company_id) REFERENCES company(id)
- fk_pay_period_locked_by FOREIGN KEY (locked_by_user_id) REFERENCES user(id)
- fk_pay_period_created_by FOREIGN KEY (created_by_user_id) REFERENCES user(id)
- chk_date_order CHECK (end_date >= start_date)
- chk_pay_date_order CHECK (pay_date >= end_date)
- chk_fiscal_quarter_valid CHECK (fiscal_quarter BETWEEN 1 AND 4)
- chk_fiscal_month_valid CHECK (fiscal_month BETWEEN 1 AND 12)
```

## 3.2.5 Employee Payroll Calculation Schema

```
Table: employee_payroll_calculation
Fields:
- id: UUID (Primary Key)
- payroll_run_id: UUID (Foreign Key to payroll_run)
- employee_id: UUID (Foreign Key to employee)
- company_id: UUID (Foreign Key to company)
- calculation_status: ENUM('Pending', 'Calculating', 'Calculated', 'Error', 'Manual Review', 'Approved')
- base_salary: DECIMAL(15,2) (Default: 0.00)
- hourly_rate: DECIMAL(10,4) (Default: 0.00)
- regular_hours: DECIMAL(8,2) (Default: 0.00)
- overtime_hours: DECIMAL(8,2) (Default: 0.00)
- double_time_hours: DECIMAL(8,2) (Default: 0.00)
- regular_pay: DECIMAL(15,2) (Default: 0.00)
- overtime_pay: DECIMAL(15,2) (Default: 0.00)
- double_time_pay: DECIMAL(15,2) (Default: 0.00)
- bonus_pay: DECIMAL(15,2) (Default: 0.00)
- commission_pay: DECIMAL(15,2) (Default: 0.00)
- allowance_pay: DECIMAL(15,2) (Default: 0.00)
- other_earnings: DECIMAL(15,2) (Default: 0.00)
- gross_pay: DECIMAL(15,2) (Default: 0.00)
- federal_tax: DECIMAL(15,2) (Default: 0.00)
- state_tax: DECIMAL(15,2) (Default: 0.00)
- local_tax: DECIMAL(15,2) (Default: 0.00)
- social_security_tax: DECIMAL(15,2) (Default: 0.00)
- medicare_tax: DECIMAL(15,2) (Default: 0.00)
- other_taxes: DECIMAL(15,2) (Default: 0.00)
- total_taxes: DECIMAL(15,2) (Default: 0.00)
- health_insurance: DECIMAL(15,2) (Default: 0.00)
- dental_insurance: DECIMAL(15,2) (Default: 0.00)
- retirement_401k: DECIMAL(15,2) (Default: 0.00)
- other_benefits: DECIMAL(15,2) (Default: 0.00)
- total_benefits: DECIMAL(15,2) (Default: 0.00)
- wage_garnishment: DECIMAL(15,2) (Default: 0.00)
- child_support: DECIMAL(15,2) (Default: 0.00)
- other_deductions: DECIMAL(15,2) (Default: 0.00)
- total_deductions: DECIMAL(15,2) (Default: 0.00)
- net_pay: DECIMAL(15,2) (Default: 0.00)
- year_to_date_gross: DECIMAL(15,2) (Default: 0.00)
- year_to_date_net: DECIMAL(15,2) (Default: 0.00)
- year_to_date_taxes: DECIMAL(15,2) (Default: 0.00)
- calculation_details: JSON (Detailed breakdown of calculations)
- error_messages: TEXT
- manual_adjustments: JSON (Manual overrides and adjustments)
- reviewed_by_user_id: UUID (Foreign Key to user)
- reviewed_at: TIMESTAMP
- created_at: TIMESTAMP (Auto)
- updated_at: TIMESTAMP (Auto)

Indexes:
- PRIMARY KEY (id)
- INDEX idx_payroll_run_id (payroll_run_id)
- INDEX idx_employee_id (employee_id)
- INDEX idx_company_id (company_id)
- INDEX idx_calculation_status (calculation_status)
- INDEX idx_gross_pay (gross_pay)
- INDEX idx_net_pay (net_pay)

Constraints:
- fk_employee_calculation_run FOREIGN KEY (payroll_run_id) REFERENCES payroll_run(id)
- fk_employee_calculation_employee FOREIGN KEY (employee_id) REFERENCES employee(id)
- fk_employee_calculation_company FOREIGN KEY (company_id) REFERENCES company(id)
- fk_employee_calculation_reviewed_by FOREIGN KEY (reviewed_by_user_id) REFERENCES user(id)
- chk_hours_valid CHECK (regular_hours >= 0 AND overtime_hours >= 0 AND double_time_hours >= 0)
```

## 3.2.6 Earnings and Deductions Schema

```
Table: payroll_earnings_deductions
Fields:
- id: UUID (Primary Key)
- payroll_calculation_id: UUID (Foreign Key to employee_payroll_calculation)
- employee_id: UUID (Foreign Key to employee)
- company_id: UUID (Foreign Key to company)
- line_type: ENUM('Earning', 'Deduction', 'Tax', 'Benefit', 'Contribution')
- category: VARCHAR(100) (Required)
- code: VARCHAR(50) (Required)
- description: VARCHAR(200) (Required)
- amount: DECIMAL(15,2) (Required)
- quantity: DECIMAL(8,2) (Default: 1.00)
- rate: DECIMAL(10,4) (Default: 0.00)
- calculation_method: ENUM('Fixed Amount', 'Percentage', 'Rate Based', 'Tiered', 'Formula')
- calculation_basis: VARCHAR(100)
- is_taxable: BOOLEAN (Default: FALSE)
- is_pre_tax: BOOLEAN (Default: FALSE)
- is_401k_eligible: BOOLEAN (Default: FALSE)
- tax_treatment: ENUM('Taxable', 'Non-Taxable', 'Pre-Tax', 'Post-Tax', 'Exempt')
- benefit_category: VARCHAR(100)
- employer_contribution: DECIMAL(15,2) (Default: 0.00)
- employee_contribution: DECIMAL(15,2) (Default: 0.00)
- third_party_payee: VARCHAR(200)
- gl_account_code: VARCHAR(50)
- cost_center_code: VARCHAR(50)
- department_code: VARCHAR(50)
- project_code: VARCHAR(50)
- is_recurring: BOOLEAN (Default: FALSE)
- recurrence_pattern: JSON (Recurrence schedule if applicable)
- effective_start_date: DATE
- effective_end_date: DATE
- calculation_details: JSON (Detailed calculation breakdown)
- created_by_user_id: UUID (Foreign Key to user)
- created_at: TIMESTAMP (Auto)
- updated_at: TIMESTAMP (Auto)

Indexes:
- PRIMARY KEY (id)
- INDEX idx_payroll_calculation_id (payroll_calculation_id)
- INDEX idx_employee_id (employee_id)
- INDEX idx_company_id (company_id)
- INDEX idx_line_type (line_type)
- INDEX idx_category (category)
- INDEX idx_code (code)
- INDEX idx_is_taxable (is_taxable)
- INDEX idx_is_pre_tax (is_pre_tax)

Constraints:
- fk_earnings_deductions_calculation FOREIGN KEY (payroll_calculation_id) REFERENCES employee_payroll_calculation(id)
- fk_earnings_deductions_employee FOREIGN KEY (employee_id) REFERENCES employee(id)
- fk_earnings_deductions_company FOREIGN KEY (company_id) REFERENCES company(id)
- fk_earnings_deductions_created_by FOREIGN KEY (created_by_user_id) REFERENCES user(id)
- chk_quantity_positive CHECK (quantity > 0)
```

## 3.2.7 Tax Calculation Schema

```
Table: payroll_tax_calculation
Fields:
- id: UUID (Primary Key)
- payroll_calculation_id: UUID (Foreign Key to employee_payroll_calculation)
- employee_id: UUID (Foreign Key to employee)
- company_id: UUID (Foreign Key to company)
- tax_type: ENUM('Federal Income', 'State Income', 'Local Income', 'Social Security', 'Medicare', 'FUTA', 'SUTA', 'Disability', 'Other')
- tax_authority: VARCHAR(100) (Required)
- tax_jurisdiction: VARCHAR(100) (Required)
- taxable_wages: DECIMAL(15,2) (Default: 0.00)
- tax_rate: DECIMAL(8,6) (Default: 0.000000)
- tax_amount: DECIMAL(15,2) (Default: 0.00)
- year_to_date_taxable_wages: DECIMAL(15,2) (Default: 0.00)
- year_to_date_tax_paid: DECIMAL(15,2) (Default: 0.00)
- annual_tax_limit: DECIMAL(15,2) (Default: 0.00)
- remaining_tax_limit: DECIMAL(15,2) (Default: 0.00)
- exemption_amount: DECIMAL(15,2) (Default: 0.00)
- allowance_amount: DECIMAL(15,2) (Default: 0.00)
- additional_withholding: DECIMAL(15,2) (Default: 0.00)
- supplemental_tax_rate: DECIMAL(8,6) (Default: 0.000000)
- calculation_method: ENUM('Percentage', 'Bracket', 'Flat Rate', 'Tiered', 'Formula')
- tax_table_version: VARCHAR(50)
- tax_form: ENUM('W-4', 'W-4P', 'State W-4', 'Other')
- filing_status: ENUM('Single', 'Married Filing Jointly', 'Married Filing Separately', 'Head of Household', 'Qualifying Widow(er)')
- allowances_claimed: INTEGER (Default: 0)
- additional_allowances: INTEGER (Default: 0)
- exemption_type: ENUM('Standard', 'Itemized', 'None')
- calculation_details: JSON (Detailed tax calculation breakdown)
- override_amount: DECIMAL(15,2) (Default: 0.00)
- override_reason: TEXT
- created_by_user_id: UUID (Foreign Key to user)
- created_at: TIMESTAMP (Auto)
- updated_at: TIMESTAMP (Auto)

Indexes:
- PRIMARY KEY (id)
- INDEX idx_payroll_calculation_id (payroll_calculation_id)
- INDEX idx_employee_id (employee_id)
- INDEX idx_company_id (company_id)
- INDEX idx_tax_type (tax_type)
- INDEX idx_tax_authority (tax_authority)
- INDEX idx_tax_jurisdiction (tax_jurisdiction)
- INDEX idx_tax_amount (tax_amount)

Constraints:
- fk_tax_calculation_calculation FOREIGN KEY (payroll_calculation_id) REFERENCES employee_payroll_calculation(id)
- fk_tax_calculation_employee FOREIGN KEY (employee_id) REFERENCES employee(id)
- fk_tax_calculation_company FOREIGN KEY (company_id) REFERENCES company(id)
- fk_tax_calculation_created_by FOREIGN KEY (created_by_user_id) REFERENCES user(id)
- chk_tax_rate_valid CHECK (tax_rate >= 0 AND tax_rate <= 1)
- chk_allowances_non_negative CHECK (allowances_claimed >= 0 AND additional_allowances >= 0)
```

## 3.2.8 Payment Processing Schema

```
Table: payroll_payment
Fields:
- id: UUID (Primary Key)
- payroll_run_id: UUID (Foreign Key to payroll_run)
- employee_id: UUID (Foreign Key to employee)
- company_id: UUID (Foreign Key to company)
- payment_method: ENUM('Direct Deposit', 'Check', 'Cash', 'Wire Transfer')
- payment_status: ENUM('Pending', 'Processed', 'Sent', 'Cleared', 'Failed', 'Cancelled', 'Reissued')
- net_pay_amount: DECIMAL(15,2) (Required)
- currency_code: VARCHAR(10) (Default: 'USD')
- exchange_rate: DECIMAL(10,6) (Default: 1.000000)
- payment_date: DATE (Required)
- processed_date: DATE
- cleared_date: DATE
- bank_name: VARCHAR(200)
- bank_account_type: ENUM('Checking', 'Savings')
- bank_account_number: VARCHAR(50) (Encrypted)
- bank_routing_number: VARCHAR(50) (Encrypted)
- bank_account_holder: VARCHAR(200)
- check_number: VARCHAR(50)
- check_date: DATE
- wire_transfer_reference: VARCHAR(100)
- receiving_bank: VARCHAR(200)
- receiving_account: VARCHAR(50)
- receiving_routing: VARCHAR(50)
- swift_code: VARCHAR(20)
- intermediary_bank: VARCHAR(200)
- payment_fees: DECIMAL(10,2) (Default: 0.00)
- batch_id: VARCHAR(100)
- transaction_id: VARCHAR(100)
- confirmation_number: VARCHAR(100)
- failure_reason: TEXT
- reissue_count: INTEGER (Default: 0)
- original_payment_id: UUID (Foreign Key to payroll_payment)
- special_instructions: TEXT
- created_by_user_id: UUID (Foreign Key to user)
- processed_by_user_id: UUID (Foreign Key to user)
- created_at: TIMESTAMP (Auto)
- updated_at: TIMESTAMP (Auto)

Indexes:
- PRIMARY KEY (id)
- INDEX idx_payroll_run_id (payroll_run_id)
- INDEX idx_employee_id (employee_id)
- INDEX idx_company_id (company_id)
- INDEX idx_payment_method (payment_method)
- INDEX idx_payment_status (payment_status)
- INDEX idx_payment_date (payment_date)
- INDEX idx_batch_id (batch_id)
- INDEX idx_transaction_id (transaction_id)

Constraints:
- fk_payment_run FOREIGN KEY (payroll_run_id) REFERENCES payroll_run(id)
- fk_payment_employee FOREIGN KEY (employee_id) REFERENCES employee(id)
- fk_payment_company FOREIGN KEY (company_id) REFERENCES company(id)
- fk_payment_original FOREIGN KEY (original_payment_id) REFERENCES payroll_payment(id)
- fk_payment_created_by FOREIGN KEY (created_by_user_id) REFERENCES user(id)
- fk_payment_processed_by FOREIGN KEY (processed_by_user_id) REFERENCES user(id)
- chk_reissue_count_non_negative CHECK (reissue_count >= 0)
```

## 3.2.9 Payroll Compliance Schema

```
Table: payroll_compliance
Fields:
- id: UUID (Primary Key)
- company_id: UUID (Foreign Key to company)
- payroll_run_id: UUID (Foreign Key to payroll_run)
- compliance_type: ENUM('Tax Filing', 'Wage Reporting', 'Labor Law', 'Minimum Wage', 'Overtime', 'Record Keeping', 'Data Privacy')
- compliance_requirement: VARCHAR(200) (Required)
- jurisdiction: VARCHAR(100) (Required)
- reporting_period: ENUM('Weekly', 'Bi-Weekly', 'Monthly', 'Quarterly', 'Semi-Annual', 'Annual')
- due_date: DATE (Required)
- filed_date: DATE
- filing_status: ENUM('Not Due', 'Pending', 'Filed', 'Late', 'Failed', 'Exempt')
- compliance_score: DECIMAL(5,2)
- risk_level: ENUM('Low', 'Medium', 'High', 'Critical')
- affected_employees: INTEGER (Default: 0)
- total_wages_reported: DECIMAL(15,2) (Default: 0.00)
- total_taxes_withheld: DECIMAL(15,2) (Default: 0.00)
- filing_method: ENUM('Electronic', 'Paper', 'Third Party')
- service_provider: VARCHAR(200)
- confirmation_number: VARCHAR(100)
- penalties_assessed: DECIMAL(15,2) (Default: 0.00)
- interest_charges: DECIMAL(15,2) (Default: 0.00)
- corrective_actions: TEXT
- next_filing_date: DATE
- supporting_documents: JSON (Array of document IDs)
- reviewed_by_user_id: UUID (Foreign Key to user)
- reviewed_at: TIMESTAMP
- created_by_user_id: UUID (Foreign Key to user)
- created_at: TIMESTAMP (Auto)
- updated_at: TIMESTAMP (Auto)

Indexes:
- PRIMARY KEY (id)
- INDEX idx_company_id (company_id)
- INDEX idx_payroll_run_id (payroll_run_id)
- INDEX idx_compliance_type (compliance_type)
- INDEX idx_jurisdiction (jurisdiction)
- INDEX idx_filing_status (filing_status)
- INDEX idx_due_date (due_date)
- INDEX idx_risk_level (risk_level)

Constraints:
- fk_payroll_compliance_company FOREIGN KEY (company_id) REFERENCES company(id)
- fk_payroll_compliance_run FOREIGN KEY (payroll_run_id) REFERENCES payroll_run(id)
- fk_payroll_compliance_reviewed_by FOREIGN KEY (reviewed_by_user_id) REFERENCES user(id)
- fk_payroll_compliance_created_by FOREIGN KEY (created_by_user_id) REFERENCES user(id)
- chk_compliance_score_range CHECK (compliance_score BETWEEN 0 AND 100)
```

## 3.2.10 Payroll Analytics Schema

```
Table: payroll_analytics
Fields:
- id: UUID (Primary Key)
- company_id: UUID (Foreign Key to company)
- department_id: UUID (Foreign Key to department)
- location_id: UUID (Foreign Key to location)
- analysis_type: ENUM('Payroll Cost', 'Tax Analysis', 'Benefit Cost', 'Overtime Analysis', 'Turnover Cost', 'Productivity', 'Compliance Metrics')
- analysis_period: ENUM('Weekly', 'Bi-Weekly', 'Monthly', 'Quarterly', 'Semi-Annual', 'Annual')
- analysis_date: DATE (Required)
- metric_name: VARCHAR(100) (Required)
- metric_value: DECIMAL(15,2)
- metric_unit: VARCHAR(50)
- benchmark_value: DECIMAL(15,2)
- variance_percentage: DECIMAL(5,2)
- target_value: DECIMAL(15,2)
- achievement_percentage: DECIMAL(5,2)
- employee_count: INTEGER
- total_payroll_cost: DECIMAL(15,2)
- average_pay_per_employee: DECIMAL(15,2)
- overtime_cost: DECIMAL(15,2)
- overtime_percentage: DECIMAL(5,2)
- benefit_cost_percentage: DECIMAL(5,2)
- tax_burden_percentage: DECIMAL(5,2)
- turnover_cost: DECIMAL(15,2)
- productivity_ratio: DECIMAL(8,4)
- compliance_score: DECIMAL(5,2)
- additional_metrics: JSON (Additional KPIs and breakdowns)
- data_quality_indicators: JSON (Data completeness and accuracy metrics)
- calculated_by_user_id: UUID (Foreign Key to user)
- created_at: TIMESTAMP (Auto)

Indexes:
- PRIMARY KEY (id)
- INDEX idx_company_id (company_id)
- INDEX idx_department_id (department_id)
- INDEX idx_location_id (location_id)
- INDEX idx_analysis_type (analysis_type)
- INDEX idx_analysis_period (analysis_period)
- INDEX idx_analysis_date (analysis_date)
- INDEX idx_metric_name (metric_name)

Constraints:
- fk_payroll_analytics_company FOREIGN KEY (company_id) REFERENCES company(id)
- fk_payroll_analytics_department FOREIGN KEY (department_id) REFERENCES department(id)
- fk_payroll_analytics_location FOREIGN KEY (location_id) REFERENCES location(id)
- fk_payroll_analytics_calculated_by FOREIGN KEY (calculated_by_user_id) REFERENCES user(id)
```

## 3.2.11 Payroll Audit Log Schema

```
Table: payroll_audit_log
Fields:
- id: UUID (Primary Key)
- company_id: UUID (Foreign Key to company)
- action: ENUM('Create', 'Update', 'Delete', 'Approve', 'Process', 'Cancel', 'Adjust', 'Reissue', 'File', 'Report')
- entity_type: ENUM('Payroll Run', 'Pay Period', 'Employee Calculation', 'Payment', 'Tax Calculation', 'Compliance', 'Earning', 'Deduction')
- entity_id: UUID
- old_values: JSON (Previous values)
- new_values: JSON (Updated values)
- field_changes: JSON (Specific field changes)
- action_reason: TEXT
- business_justification: TEXT
- impact_assessment: TEXT
- affected_employees: INTEGER (Default: 0)
- financial_impact: DECIMAL(15,2)
- compliance_impact: TEXT
- performed_by_user_id: UUID (Foreign Key to user)
- ip_address: VARCHAR(45)
- user_agent: TEXT
- session_id: VARCHAR(100)
- timestamp: TIMESTAMP (Auto)
- additional_context: JSON (Extra context information)

Indexes:
- PRIMARY KEY (id)
- INDEX idx_company_id (company_id)
- INDEX idx_action (action)
- INDEX idx_entity_type (entity_type)
- INDEX idx_performed_by (performed_by_user_id)
- INDEX idx_timestamp (timestamp)
- INDEX idx_financial_impact (financial_impact)

Constraints:
- fk_payroll_audit_company FOREIGN KEY (company_id) REFERENCES company(id)
- fk_payroll_audit_performed_by FOREIGN KEY (performed_by_user_id) REFERENCES user(id)
